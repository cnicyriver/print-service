(function(){var n,r,e,u,f,t,i;r=require("../lib/pos");t=require("../lib/nconf");i=require("orm");f=require("moment");u=require("cluster");e=require("async");n={waiting:0,success:1,fail:2,error:3,printing:4,other:5};module.exports=function(e){var o;return o=e.define("print_log",{print_log_id:{type:"serial"},addtime:{type:"integer",size:11},printIP:{type:"text"},print_message:{type:"object"},is_ok:{type:"integer"},success_no:{type:"text"},print_type:{type:"text"},print_time:{type:"integer",size:11},trans_id:{type:"text"},print_nums:{type:"integer",size:11},print_sort:{type:"integer"}},{id:"print_log_id",methods:{print:function(t){var i;return t==null&&(t=function(){}),i=this.is_ok,this.is_ok=this.printIP?n.printing:n.other,this.print_time=(new Date).getTime()/1e3,this.trans_id=null,this.save(function(e){return function(o){var h,s;return o||!e.printIP?t(e):(s=r.print(e.printIP,e.print_message),h=e.is_ok,e.is_ok=s===0?n.success:n.fail,s==="OpenError"&&(e.is_ok=n.error),e.print_nums++,console.log(f(new Date).format("HH:mm:ss SSS"),"进程,日志",u.worker.id,e.print_log_id,i,h,e.is_ok,s,e.print_nums),e.save(function(){return t(e)}))}}(this))}}}),o.getOneByStatus=function(n,t){t==null&&(t=function(){});return this.one({is_ok:n},t)},o.getOneByPrintManage=function(n,t){t==null&&(t=function(){});return this.one({print_id:n},t)},o.loopFill=function(t,i){return i==null&&(i=function(){}),this.find({print_id:t,is_ok:n.error}).each(function(t){return t.is_ok=n.waiting}).save(function(n){return function(){return n.loopPrint(null,i)}}(this))},o.loopPrint=function(t){return t==null&&(t=function(){}),this.find({is_ok:n.waiting}).limit(1).order("print_sort").run(function(n,i){return n||!i||i.length===0?t():i[0].print(t)})},o.clearOld=function(n){var r,u;return(n==null&&(n=function(){}),r=t.get("print:clearOldTimes"),r===0)?n():(u=((new Date).getTime()-r)/1e3,this.find({addtime:i.lt(u)}).remove(n))},o.checkTimeoutLogs=function(r){var f,u;return(r==null&&(r=function(){}),u=t.get("print:printTimeout"),u===0)?r():(f=((new Date).getTime()-u)/1e3,this.find({print_time:i.lt(f),is_ok:n.printing}).each(function(t){return t.is_ok=n.waiting}).save(r))}}}).call(this);
/*
//# sourceMappingURL=print_log.min.js.map
*/